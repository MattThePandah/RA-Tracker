<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSFest Challenge Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üéÆ PSFest Challenge Tracker</h1>
            <p class="subtitle">Track your PlayStation game completion journey</p>
        </header>

        <div class="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Games</h3>
                    <div class="stat-number" id="totalGames">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="stat-number" id="completedGames">0</div>
                </div>
                <div class="stat-card">
                    <h3>In Progress</h3>
                    <div class="stat-number" id="inProgressGames">0</div>
                </div>
                <div class="stat-card">
                    <h3>Remaining</h3>
                    <div class="stat-number" id="remainingGames">0</div>
                </div>
            </div>

            <div class="progress-section">
                <h3>Challenge Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">0% Complete</p>
            </div>

            <div class="current-game" id="currentGameSection" style="display: none;">
                <h3>Current Game</h3>
                <div class="current-game-info" id="currentGameInfo">
                    <img id="currentGameImage" src="" alt="">
                    <div>
                        <h4 id="currentGameTitle"></h4>
                        <p id="currentGameConsole"></p>
                        <p id="currentGameStatus"></p>
                    </div>
                </div>
            </div>

            <div class="navigation-grid">
                <a href="#" onclick="openWheel()" class="nav-card wheel-card">
                    <div class="nav-icon">üé≤</div>
                    <h3>Game Wheel</h3>
                    <p>Spin to select your next game</p>
                </a>

                <a href="games.html" class="nav-card games-card">
                    <div class="nav-icon">üìö</div>
                    <h3>Game Library</h3>
                    <p>Manage and track all games</p>
                </a>

                <a href="obs.html" class="nav-card obs-card">
                    <div class="nav-icon">üì∫</div>
                    <h3>OBS Display</h3>
                    <p>Streaming overlay view</p>
                </a>

                <button class="nav-card settings-card" onclick="openSettings()">
                    <div class="nav-icon">‚öôÔ∏è</div>
                    <h3>Settings</h3>
                    <p>Configure API and challenge</p>
                </button>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="startChallenge()" id="startChallengeBtn">
                    Start Challenge
                </button>
                <button class="btn btn-secondary" onclick="fetchGames()" id="fetchGamesBtn">
                    Sync Games from API
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    Export All Data
                </button>
                <button class="btn btn-info" onclick="downloadGamesJson()">
                    Download games.json
                </button>
                <button class="btn btn-danger" onclick="resetAllGames()">
                    Reset All Games
                </button>
                <button class="btn btn-info" onclick="debugStorage()">
                    Debug Storage
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close" onclick="closeSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiUsername">RetroAchievements Username:</label>
                    <input type="text" id="apiUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="apiKey">RetroAchievements API Key:</label>
                    <input type="password" id="apiKey" placeholder="Enter API key">
                </div>
                <div class="form-group">
                    <label for="challengeTitle">Challenge Title:</label>
                    <input type="text" id="challengeTitle" value="PSFest Challenge">
                </div>
                <div class="form-group">
                    <label for="challengeGoal">Challenge Goal:</label>
                    <input type="text" id="challengeGoal" value="Complete all PlayStation games">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    <button class="btn btn-secondary" onclick="testConnection()">Test API Connection</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading games from RetroAchievements...</p>
    </div>

    <script src="js/retroAchievements.js"></script>
    <script src="js/gameManager.js"></script>
    <script>
        let gameManager;

        async function init() {
            gameManager = new GameManager();
            await gameManager.init();
            updateDashboard();
            
            if (!gameManager.settings.challenge_start_date) {
                document.getElementById('startChallengeBtn').style.display = 'block';
            }
        }

        function updateDashboard() {
            const stats = gameManager.getChallengeStats();
            
            document.getElementById('totalGames').textContent = stats.totalGames;
            document.getElementById('completedGames').textContent = stats.completedGames;
            document.getElementById('inProgressGames').textContent = stats.inProgressGames;
            document.getElementById('remainingGames').textContent = stats.remainingGames;
            
            document.getElementById('progressFill').style.width = stats.completionPercentage + '%';
            document.getElementById('progressText').textContent = stats.completionPercentage + '% Complete';
            
            const currentGame = gameManager.getCurrentGame();
            if (currentGame) {
                document.getElementById('currentGameSection').style.display = 'block';
                document.getElementById('currentGameTitle').textContent = currentGame.title;
                document.getElementById('currentGameConsole').textContent = currentGame.console;
                document.getElementById('currentGameStatus').textContent = currentGame.status;
                document.getElementById('currentGameImage').src = currentGame.image_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" fill="%23ddd"/></svg>';
            }
        }

        async function startChallenge() {
            gameManager.startChallenge();
            document.getElementById('startChallengeBtn').style.display = 'none';
            updateDashboard();
        }

        async function fetchGames() {
            if (!gameManager.settings.retroachievements?.username || !gameManager.settings.retroachievements?.api_key) {
                alert('Please configure your RetroAchievements credentials in Settings first.');
                openSettings();
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('fetchGamesBtn').disabled = true;

            try {
                await gameManager.fetchGamesFromAPI();
                updateDashboard();
                alert('Games successfully synced from RetroAchievements!');
            } catch (error) {
                alert('Failed to fetch games: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('fetchGamesBtn').disabled = false;
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
            document.getElementById('apiUsername').value = gameManager.settings.retroachievements?.username || '';
            document.getElementById('apiKey').value = gameManager.settings.retroachievements?.api_key || '';
            document.getElementById('challengeTitle').value = gameManager.settings.challenge_settings?.title || 'PSFest Challenge';
            document.getElementById('challengeGoal').value = gameManager.settings.challenge_settings?.goal || 'Complete all PlayStation games';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        async function saveSettings() {
            gameManager.settings.retroachievements = {
                username: document.getElementById('apiUsername').value,
                api_key: document.getElementById('apiKey').value
            };
            
            gameManager.settings.challenge_settings = {
                title: document.getElementById('challengeTitle').value,
                goal: document.getElementById('challengeGoal').value
            };
            
            await gameManager.saveSettings();
            closeSettings();
            alert('Settings saved successfully!');
        }

        async function testConnection() {
            const username = document.getElementById('apiUsername').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!username || !apiKey) {
                alert('Please enter both username and API key.');
                return;
            }

            try {
                const isValid = await RetroAchievementsAPI.testConnection(username, apiKey);
                if (isValid) {
                    alert('‚úÖ Connection successful!');
                } else {
                    alert('‚ùå Connection failed. Please check your credentials.');
                }
            } catch (error) {
                alert('‚ùå Connection failed: ' + error.message);
            }
        }

        function exportData() {
            const data = gameManager.exportData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `psfest-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function downloadGamesJson() {
            if (gameManager.games.length === 0) {
                alert('No games loaded. Please sync games from API first.');
                return;
            }

            const blob = new Blob([JSON.stringify(gameManager.games, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'games.json';
            a.click();
            
            alert(`Downloaded games.json with ${gameManager.games.length} games!\n\nReplace the games.json file in your data/ folder with this download.`);
        }

        async function resetAllGames() {
            if (!confirm('This will reset ALL games to "Not Started" status. Are you sure?')) {
                return;
            }

            // Reset all games to "Not Started"
            gameManager.games.forEach(game => {
                if (game.status !== 'Not Started') {
                    game.status = 'Not Started';
                    game.completion_time = null;
                    game.date_started = null;
                    game.date_finished = null;
                    game.rating = null;
                    game.notes = '';
                }
            });

            // Clear current game
            gameManager.settings.current_game_id = null;
            gameManager.settings.challenge_start_date = null;

            // Save changes
            await gameManager.saveGames();
            await gameManager.saveSettings();

            // Update dashboard
            updateDashboard();
            
            alert('All games have been reset to "Not Started" status!');
        }

        function debugStorage() {
            console.log('=== STORAGE DEBUG FROM DASHBOARD ===');
            console.log('All localStorage keys:', Object.keys(localStorage));
            console.log('localStorage.length:', localStorage.length);
            
            const gamesData = localStorage.getItem('psfest_games');
            const settingsData = localStorage.getItem('psfest_settings');
            
            console.log('Direct localStorage.getItem("psfest_games"):', !!gamesData);
            console.log('Direct localStorage.getItem("psfest_settings"):', !!settingsData);
            
            // Also check gameManager's internal data
            console.log('GameManager.games.length:', gameManager.games.length);
            
            if (gamesData) {
                const games = JSON.parse(gamesData);
                console.log('Games in localStorage:', games.length);
                
                // Check status distribution
                const statusCounts = games.reduce((acc, game) => {
                    acc[game.status] = (acc[game.status] || 0) + 1;
                    return acc;
                }, {});
                console.log('Status distribution:', statusCounts);
                
                // Show first few games
                console.log('First 5 games:', games.slice(0, 5).map(g => ({
                    title: g.title,
                    status: g.status,
                    console: g.console
                })));
                
                // Check for non-completed games
                const available = games.filter(game => game.status !== 'Completed');
                console.log('Available (non-completed) games:', available.length);
                
                alert(`Storage Debug (localStorage):\n\nTotal games: ${games.length}\nAvailable games: ${available.length}\n\nStatus breakdown:\n${Object.entries(statusCounts).map(([status, count]) => `${status}: ${count}`).join('\n')}\n\nCheck console for detailed info.`);
            } else if (gameManager.games.length > 0) {
                // Games are in GameManager but not localStorage
                const games = gameManager.games;
                const statusCounts = games.reduce((acc, game) => {
                    acc[game.status] = (acc[game.status] || 0) + 1;
                    return acc;
                }, {});
                
                console.log('Games in GameManager (not localStorage):', games.length);
                console.log('GameManager status distribution:', statusCounts);
                
                alert(`Storage Debug (GameManager only):\n\nGames in memory: ${games.length}\nNOT in localStorage!\n\nStatus breakdown:\n${Object.entries(statusCounts).map(([status, count]) => `${status}: ${count}`).join('\n')}\n\nTrying to save to localStorage now...`);
                
                // Try to save to localStorage
                gameManager.saveGames();
            } else {
                alert('No games data found anywhere!');
            }
            
            if (settingsData) {
                console.log('Settings in localStorage:', JSON.parse(settingsData));
            }
            
            console.log('=== END STORAGE DEBUG ===');
        }


        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }

        function openWheel() {
            // Force save games to localStorage before navigating
            if (gameManager.games.length > 0) {
                console.log('Dashboard: Force saving games before wheel navigation...');
                gameManager.saveGames();
                
                // Wait a moment for save to complete
                setTimeout(() => {
                    window.location.href = 'wheel.html';
                }, 100);
            } else {
                alert('No games loaded. Please sync games from API first.');
            }
        }

        init();
    </script>
</body>
</html>